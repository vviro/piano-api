<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Chat</title>

    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>

    <script src="http://localhost:8124/socket.io/socket.io.js"></script>

    <style type="text/css">
        .hidden {
            visibility:hidden;
            width:0px;
            height:0px;
            margin:0px;
            padding:0px;
            border-style:none;
            border-width:0px;
            max-width:0px;
            max-height:0px;
        }
        #msg {
            width:20em;
            height:24em;
            margin:.5em 0 .5em 0;
            padding:.5em;
            background-color:#eee;
            border:solid 1px #888;
            white-space:pre;
            font-family:Courier New, monospace;
            font-size:.75em;
            overflow:auto;
        }

        #currentUser {
            width:20em;
            height:24em;
            margin:.5em 0 .5em 0;
            padding:.5em;
            background-color:#eee;
            border:solid 1px #888;
            white-space:pre;
            font-family:Courier New, monospace;
            font-size:.75em;
            overflow:auto;
        }
    </style>



    <script>

        var socket = io.connect('http://localhost:8124');
        socket.on('connect', function() {
            socket.emit('addme', prompt('Pick a username(no spaces)'));
        });

        socket.on('existing', function() {
            socket.emit('addme', prompt('Username already in use. Please take a different Username'));
        });

        socket.on('invalid', function() {
            socket.emit('addme', prompt('Invalid username. Please take a different Username'));
        });

        socket.on('count', function(count) {
            document.getElementById('count').innerHTML = 'Currently online: '+count;
        });


        socket.on('onlineUser', function(array) {
            document.getElementById('currentUser').innerHTML = "";
            var p = document.createElement('p');
            for (var i=0;i<array.length;i++)
            {
                p.innerHTML += array[i]+"<br>";
                document.getElementById('currentUser').appendChild(p);
            }
        })

        socket.on('chat',function(username, data) {
            var p = document.createElement('p');
            p.innerHTML = username + ': ' + data;
            document.getElementById('output').appendChild(p);
        });

        socket.on('whisperMessageReceive',function(username, data) {
            var p = document.createElement('p');
            p.innerHTML = 'private message from ' + username + ': ' + data;
            document.getElementById('output').appendChild(p);
        });

        socket.on('whisperMessageSend',function(username, data) {
            var p = document.createElement('p');
            p.innerHTML = 'private message to ' + username + ': ' + data;
            document.getElementById('output').appendChild(p);
        });

        /**
         * Klappt irgendwie noch nicht
        $(function() {
            $('#sendtext').on('click', function() {
                var text = $('#data').val();
                socket.emit('sendchat', text);
            }, false);
        })
        **/

        window.addEventListener('load',function() {
            document.getElementById('sendtext').addEventListener('click',
                    function() {
                        var text = document.getElementById('data').value;

                        socket.emit('sendchat', text);
                        document.getElementById('data').value = "";


                        //socket.emit('sendJSON', {type:1,name:'test'})

                    }, false);
        }, false);



    </script>
</head>
<body>

<object id="Jazz1" classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90" class="hidden">
    <object id="Jazz2" type="audio/x-jazz" class="hidden">
        <p style="visibility:visible;">This page requires <a href=http://jazz-soft.net>Jazz-Plugin</a> ...</p>
    </object>
</object>

<p>
    MIDI Input:
    <select id=midiIn onchange='changeMidi();'>
        <option value="">Not connected</option>
    </select>
<div id=msg></div>
</p>

<script><!--
var Jazz;
var active_element;
var current_in;
var msg;
var sel;

//// Callback function
function midiProc(t,a,b,c){
    msg.innerHTML=msg.innerHTML+midiString(a,b,c)+"<br>";
    msg.scrollTop=msg.scrollHeight;
}
function midiString(a,b,c){
    var cmd=Math.floor(a/16);
    var note=['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'][b%12]+Math.floor(b/12);
    a=a.toString(16);
    b=(b<16?'0':'')+b.toString(16);
    c=(c<16?'0':'')+c.toString(16);
    var str=a+" "+b+" "+c+"    ";
    if(cmd==8){
        str+="Note Off   "+note;
    }
    else if(cmd==9){
        str+="Note On    "+note;
    }
    else if(cmd==10){
        str+="Aftertouch "+note;
    }
    else if(cmd==11){
        str+="Control    "+b;
    }
    else if(cmd==12){
        str+="Program    "+b;
    }
    else if(cmd==13){
        str+="Aftertouch";
    }
    else if(cmd==14){
        str+="Pitch Wheel";
    }
    return str;
}

//// Listbox
function changeMidi(){
    try{
        if(sel.selectedIndex){
            current_in=Jazz.MidiInOpen(sel.options[sel.selectedIndex].value,midiProc);
        } else {
            Jazz.MidiInClose(); current_in='';
        }
        for(var i=0;i<sel.length;i++){
            if(sel[i].value==current_in) sel[i].selected=1;
        }
    }
    catch(err){}
}

//// Connect/disconnect
function connectMidiIn(){
    try{
        var str=Jazz.MidiInOpen(current_in,midiProc);
        for(var i=0;i<sel.length;i++){
            if(sel[i].value==str) sel[i].selected=1;
        }
    }
    catch(err){}
}
function disconnectMidiIn(){
    try{
        Jazz.MidiInClose(); sel[0].selected=1;
    }
    catch(err){}
}
function onFocusIE(){
    active_element=document.activeElement;
    connectMidiIn();
}
function onBlurIE(){
    if(active_element!=document.activeElement){ active_element=document.activeElement; return;}
    disconnectMidiIn();
}

//funktion testet welche midi anschluesse da sind und fuegt neue hinzu
function checkForMidi(){
    try{
        current_in=Jazz.MidiInOpen(0,midiProc);
        var list=Jazz.MidiInList();

        for(var i in list){
            //hier noch testen obs schon drin ist das element
            var contained = false;
            for(var j in sel.options){
                if(sel.options[j].value == list[i]){
                    contained = true;
                }
            }
            //nur wenns noch nicht da war wirds neu hinzugefuegt
            if(!contained){
                sel[sel.options.length]=new Option(list[i],list[i],list[i]==current_in,list[i]==current_in);
            }
        }
    }
    catch(err){}
}

//// Initialize
Jazz=document.getElementById("Jazz1"); if(!Jazz || !Jazz.isJazz) Jazz = document.getElementById("Jazz2");
msg=document.getElementById("msg");
sel=document.getElementById("midiIn");

checkForMidi();


//hier wird der interval zum test auf midi geraete gemacht
var intervalHandle = null
$(document)
        .on('focus', function() {
            //testet jede sekunde auf midi anschluesse
            intervalHandle = setInterval(checkForMidi, 1000);
        })
        .on('blur', function() {
            clearInterval(intervalHandle);
        });
/**
if(navigator.appName=='Microsoft Internet Explorer'){document.onfocusin=onFocusIE; document.onfocusout=onBlurIE;}
else{window.onfocus=connectMidiIn; window.onblur=disconnectMidiIn;}
**/
--></script>




<div id="count">Offline</div>

<p>
    Currently Online:

<div id=currentUser></div>
</p>


<div id="output"></div>
<div id="send">
    <input type="text" id="data" size="100" /><br />
    <input type="button" id="sendtext" value="Send Text" />
</div>
</body>
</html>